<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯ÙˆØ±Ø§Øª - ExamPro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header
            style="background: white; padding: 1rem 0; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-right"></i>
                        Ø±Ø¬ÙˆØ¹
                    </button>
                    <div
                        style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-graduation-cap" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800); margin: 0;">Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 0.9rem;">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ ÙˆØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
                            Ø§Ù„Ù…ØªØ§Ø­Ø©</p>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-info" onclick="syncWithBackend()" title="Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…">
                        <i class="fas fa-sync"></i>
                        Ù…Ø²Ø§Ù…Ù†Ø©
                    </button>
                    <button class="btn btn-secondary" onclick="refreshCourses()">
                        <i class="fas fa-refresh"></i>
                        ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </div>
        </header>

        <!-- Available Courses -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
            </div>
            <div id="coursesList" style="max-height: 600px; overflow-y: auto;">
                <!-- Courses will be loaded here -->
                <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª...</p>
                </div>
            </div>
        </div>


    </div>

    <script src="../js/api.js"></script>
    <script>
        // Check authentication
        if (!checkAuth()) {
            window.location.href = '../login.html';
        }

        // Check if user is student
        if (!api.isStudent()) {
            showAlert('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©', 'danger');
            setTimeout(() => {
                window.location.href = '../login.html';
            }, 2000);
        }

        // Load courses data
        async function loadCourses() {
            try {
                console.log('ğŸ“š Loading courses...');
                showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª...');

                // Get all available courses
                const allCourses = await api.getAllCourses();
                console.log('âœ… All courses loaded:', allCourses);

                // Get student's current enrollments
                const enrollmentStatus = await api.checkEnrollmentStatus();
                console.log('âœ… Enrollment status loaded:', enrollmentStatus);

                // Clean up inconsistent local storage data if backend is available
                if (enrollmentStatus.enrolledCourses && enrollmentStatus.enrolledCourses.length >= 0) {
                    const localEnrollments = JSON.parse(localStorage.getItem('enrolledCourses') || '[]');
                    
                    // If we have backend data, sync local storage with it
                    if (enrollmentStatus.enrolledCourses.length > 0 || localEnrollments.length > 0) {
                        localStorage.setItem('enrolledCourses', JSON.stringify(enrollmentStatus.enrolledCourses));
                        console.log('ğŸ”„ Synced local storage with backend data');
                    }
                }

                // Display courses with enrollment status
                const coursesHtml = allCourses.map((course, index) => {
                    // Check if enrolled - handle both online and offline modes
                    let isEnrolled = false;
                    
                    if (enrollmentStatus.enrolledCourses && enrollmentStatus.enrolledCourses.length > 0) {
                        isEnrolled = enrollmentStatus.enrolledCourses.some(e => {
                            const courseId = course.id || course.Id;
                            const enrolledCourseId = e.courseId;
                            const match = enrolledCourseId === courseId;
                            console.log(`ğŸ” Checking: Course ID ${courseId} vs Enrolled Course ID ${enrolledCourseId} = ${match}`);
                            return match;
                        });
                    }

                    // Skip duplicates by checking if we've already rendered this course
                    if (index > 0) {
                        const isDuplicate = allCourses.slice(0, index).some(prevCourse =>
                            (prevCourse.id || prevCourse.Id) === (course.id || course.Id)
                        );
                        if (isDuplicate) return '';
                    }

                    // Log enrollment status for debugging
                    console.log(`ğŸ“Š Course "${course.courseName || course.CourseName}" (ID: ${course.id || course.Id}) - Enrolled: ${isEnrolled}`);

                    return `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1.5rem; border: 1px solid var(--gray-200); margin-bottom: 1rem; border-radius: 8px; background: ${isEnrolled ? 'var(--success-light)' : 'white'};">
                            <div style="width: 60px; height: 60px; background: ${isEnrolled ? 'var(--success)' : 'var(--primary)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${isEnrolled ? 'fa-check' : 'fa-book'}" style="color: white; font-size: 1.2rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 0.5rem 0; color: var(--gray-800); font-size: 1.2rem;">${course.courseName || course.CourseName || 'Ø¯ÙˆØ±Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</h3>
                                <p style="margin: 0 0 1rem 0; color: var(--gray-600); line-height: 1.5;">${course.description || course.Description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <span style="color: var(--gray-500); font-size: 0.9rem;">
                                        <i class="fas fa-user"></i> ${course.teacherName || course.TeacherName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                                    </span>
                                    <span style="color: var(--gray-500); font-size: 0.9rem;">
                                        <i class="fas fa-calendar"></i> ${new Date(course.createdDate || course.CreatedDate).toLocaleDateString('ar-SA')}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${isEnrolled ?
                            `<span style="color: var(--success); font-weight: 600; padding: 0.5rem 1rem; background: var(--success-light); border-radius: 4px;">
                                        <i class="fas fa-check-circle"></i> Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
                                    </span>
                                    <button class="btn btn-danger" onclick="unenrollFromCourse(${course.id || course.Id}, '${course.courseName || course.CourseName || 'Ø¯ÙˆØ±Ø©'}')">
                                        <i class="fas fa-user-minus"></i>
                                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                                    </button>` :
                            `<button class="btn btn-primary" onclick="enrollInCourse(${course.id || course.Id}, '${course.courseName || course.CourseName || 'Ø¯ÙˆØ±Ø©'}')">
                                        <i class="fas fa-user-plus"></i>
                                        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©
                                    </button>`
                        }
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('coursesList').innerHTML = coursesHtml || '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';

            } catch (error) {
                console.error('âŒ Failed to load courses:', error);
                document.getElementById('coursesList').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 2rem;">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª: ' + error.message + '</p>';
            } finally {
                hideLoading();
            }
        }

        // Enroll in specific course
        async function enrollInCourse(courseId, courseName) {
            try {
                console.log(`ğŸ“ Enrolling in course: ${courseName} (ID: ${courseId})`);
                console.log(`ğŸ” Course ID type: ${typeof courseId}, value:`, courseId);

                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¯ÙˆØ±Ø© "${courseName}"ØŸ`)) {
                    return;
                }

                showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©...');

                console.log(`ğŸ“¡ Calling API with courseId: ${courseId}`);
                const result = await api.enrollInCourse(courseId);
                console.log('âœ… Enrolled in course:', result);

                // Verify that only this course was enrolled
                const currentStatus = await api.checkEnrollmentStatus();
                const thisCourseEnrolled = currentStatus.enrolledCourses.some(e => 
                    (e.courseId === courseId || e.CourseId === courseId)
                );
                
                if (thisCourseEnrolled) {
                    showAlert(`ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¯ÙˆØ±Ø© "${courseName}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                } else {
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'warning');
                }

                // Reload courses immediately to show updated status
                await loadCourses();

            } catch (error) {
                console.error('âŒ Error enrolling in course:', error);
                
                // If "Already enrolled" error, just refresh UI without showing message
                if (error.message && error.message.includes('Already enrolled in this course')) {
                    console.log('ğŸ“ User was already enrolled, refreshing UI...');
                    // Just reload courses to fix the UI state
                    await loadCourses();
                } else {
                    showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©: ' + error.message, 'danger');
                    // Still reload courses to ensure UI is consistent
                    await loadCourses();
                }
            } finally {
                hideLoading();
            }
        }

        // Enroll in all courses
        async function enrollInAllCourses() {
            try {
                console.log('ğŸ“ Enrolling in all courses...');

                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©ØŸ')) {
                    return;
                }

                showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª...');

                const result = await api.enrollStudentInAllCourses();
                console.log('âœ… Enrolled in all courses:', result);

                showAlert(`ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ ${result.newEnrollments} Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©!`, 'success');

                // Reload courses to show updated status
                setTimeout(() => {
                    loadCourses();
                }, 1500);

            } catch (error) {
                console.error('âŒ Error enrolling in all courses:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // Unenroll from course
        async function unenrollFromCourse(courseId, courseName) {
            try {
                console.log(`ğŸšª Unenrolling from course: ${courseName} (ID: ${courseId})`);

                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø¯ÙˆØ±Ø© "${courseName}"ØŸ`)) {
                    return;
                }

                showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...');

                const result = await api.unenrollFromCourse(courseId);
                console.log('âœ… Unenrolled from course:', result);

                showAlert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø¯ÙˆØ±Ø© "${courseName}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

                // Reload courses immediately to show updated status
                await loadCourses();

            } catch (error) {
                console.error('âŒ Error unenrolling from course:', error);
                
                // If "Not enrolled" error, just refresh UI without showing message
                if (error.message && error.message.includes('Not enrolled in this course')) {
                    console.log('ğŸ“ User was not enrolled, refreshing UI...');
                    // Just reload courses to fix the UI state
                    await loadCourses();
                } else {
                    showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message, 'danger');
                    // Still reload courses to ensure UI is consistent
                    await loadCourses();
                }
            } finally {
                hideLoading();
            }
        }

        // Refresh courses
        async function refreshCourses() {
            await loadCourses();
            showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª', 'info');
        }

        // Check enrollment status
        async function checkEnrollmentStatus() {
            try {
                const status = await api.checkEnrollmentStatus();
                console.log('ğŸ“Š Enrollment status:', status);

                const enrolledCount = status.enrolledCoursesCount || status.EnrolledCoursesCount;
                const totalCount = status.totalCoursesCount || status.TotalCoursesCount;

                if (enrolledCount === 0) {
                    showAlert('Ø£Ù†Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ Ø¯ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
                } else if (enrolledCount === totalCount) {
                    showAlert(`Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (${enrolledCount}/${totalCount})`, 'success');
                } else {
                    showAlert(`Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙÙŠ ${enrolledCount} Ù…Ù† ${totalCount} Ø¯ÙˆØ±Ø© Ù…ØªØ§Ø­Ø©`, 'info');
                }

            } catch (error) {
                console.error('âŒ Error checking enrollment status:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'danger');
            }
        }

        // Clear local enrollment data and sync with backend
        async function syncWithBackend() {
            try {
                console.log('ğŸ”„ Syncing with backend...');
                showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…...');
                
                // Clear local storage to get fresh data from backend
                localStorage.removeItem('enrolledCourses');
                
                // Reload courses to get fresh data
                await loadCourses();
                
                showAlert('ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('âŒ Error syncing with backend:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // Logout function
        function performLogout() {
            console.log('ğŸšª Logout button clicked');
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                api.logout();
            }
        }

        // Go back
        function goBack() {
            window.location.href = 'dashboard.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ Student courses page loaded');
            loadCourses();
        });
    </script>
</body>

</html>