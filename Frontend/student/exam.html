<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - ExamPro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .question-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .option-item {
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .option-item:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            border-width: 3px;
        }

        .option-letter {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-600);
        }

        .option-item.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--danger);
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .question-navigation {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .nav-btn.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .nav-btn.unanswered {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header
            style="position: sticky; top: 0; z-index: 1000; background: white; padding: 1rem 0; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-clipboard-list" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800); margin: 0;">ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 0.9rem;">Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="timer" id="timer">
                        <i class="fas fa-clock"></i>
                        <span id="timeRemaining">00:00</span>
                    </div>
                    <button id="headerSubmitBtn" class="btn btn-success" onclick="submitExam()" style="display: none;">
                        <i class="fas fa-paper-plane"></i>
                        ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <!-- Question Navigation -->
        <div class="question-navigation" id="questionNavigation">
            <!-- Navigation buttons will be generated dynamically -->
        </div>

        <div id="loading" style="text-align: center; padding: 4rem;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>
            <p style="margin-top: 1rem; color: var(--gray-600);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p>
        </div>

        <div id="examContent" style="display: none;">
            <!-- Questions will be loaded here -->
            
            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 12px;">
                <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" style="display: none;">
                    <i class="fas fa-arrow-right"></i>
                    Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                
                <div style="display: flex; gap: 1rem;">
                    <span id="questionCounter" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border-radius: 8px; font-weight: 600;">
                        Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 1
                    </span>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">
                        Ø§Ù„ØªØ§Ù„ÙŠ
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    
                    <button id="submitBtn" class="btn btn-success" onclick="submitExam()" style="display: none;">
                        <i class="fas fa-paper-plane"></i>
                        ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
            </div>
        </div>

        <div id="error" style="display: none; text-align: center; padding: 4rem; color: var(--danger);">
            <i class="fas fa-exclamation-triangle fa-3x"></i>
            <h3 style="margin-top: 1rem;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            <p id="errorMessage">ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>
            <button class="btn btn-primary" onclick="window.location.href='exams.html'" style="margin-top: 1rem;">Ø§Ù„Ø¹ÙˆØ¯Ø©
                Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Check Authentication
        if (!checkAuth()) {
            window.location.href = '../login.html';
        }

        // Check if user is student
        if (!api.isStudent()) {
            showAlert('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©', 'danger');
            setTimeout(() => {
                window.location.href = '../login.html';
            }, 2000);
        }

        // Get Exam ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');

        if (!examId) {
            window.location.href = 'exams.html';
        }

        let examData = null;
        let currentQuestionIndex = 0;
        let answers = {};
        let timer = null;
        let timeRemaining = 0;

        // Load Exam Data
        async function loadExam() {
            try {
                console.log('ğŸ“‹ Loading exam:', examId);
                showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

                // Start the exam first
                const startResult = await api.startStudentExam(examId);
                console.log('âœ… Exam started:', startResult);

                // Get exam questions
                examData = await api.getStudentExamQuestions(examId);
                console.log('âœ… Exam questions loaded:', examData);

                if (!examData || !examData.questions || examData.questions.length === 0) {
                    throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
                }

                // Initialize answers object
                examData.questions.forEach(q => {
                    answers[q.id] = null;
                });

                // Start timer
                startTimer();

                // Render first question
                renderQuestion(0);
                renderNavigation();

                // Hide loading and show exam content
                hideLoading();
                document.getElementById('examContent').style.display = 'block';

            } catch (error) {
                console.error('âŒ Error loading exam:', error);
                hideLoading();
                document.getElementById('error').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';
            }
        }

        // Timer Functions
        function startTimer() {
            // Calculate duration in seconds - check all possible property names
            const duration = examData?.duration || examData?.DurationMinutes || examData?.remainingMinutes || 60;
            timeRemaining = duration * 60; // Convert to seconds

            if (timeRemaining > 0) {
                updateTimerDisplay();
                timer = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();

                    if (timeRemaining <= 0) {
                        clearInterval(timer);
                        submitExam();
                    }
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeRemaining').textContent = display;

            // Change color based on time
            const timerElement = document.getElementById('timer');
            if (timeRemaining <= 300) { // 5 minutes
                timerElement.style.color = 'var(--danger)';
            } else if (timeRemaining <= 600) { // 10 minutes
                timerElement.style.color = 'var(--warning)';
            }
        }

        // Question Rendering
        function renderQuestion(index) {
            if (index < 0 || index >= examData.questions.length) return;

            currentQuestionIndex = index;
            const question = examData.questions[index];

            const questionHtml = `
                <div class="question-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.3rem; font-weight: 600; color: var(--gray-800); margin: 0;">
                            <span style="color: var(--primary); margin-left: 0.5rem;">Ø³ ${index + 1}:</span>
                            ${question.questionText || question.QuestionText || ''}
                        </h3>
                        <span style="color: var(--gray-500); font-size: 0.9rem;">
                            ${question.marks || question.Marks || 1} Ø¯Ø±Ø¬Ø©
                        </span>
                    </div>
                    
                    <div class="options-list">
                        ${renderOptions(question)}
                    </div>
                    
                    <!-- Next button inside question -->
                    <div style="margin-top: 1.5rem; text-align: left;">
                        ${index < examData.questions.length - 1 ? `
                            <button class="btn btn-primary" onclick="nextQuestion()" style="min-width: 120px;">
                                Ø§Ù„ØªØ§Ù„ÙŠ
                                <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('examContent').innerHTML = questionHtml;
            updateProgressBar();
            updateNavigation();
            updateQuestionCounter();
        }

        function renderOptions(question) {
            const options = [
                { id: 'A', text: question.optionA || question.OptionA },
                { id: 'B', text: question.optionB || question.OptionB },
                { id: 'C', text: question.optionC || question.OptionC },
                { id: 'D', text: question.optionD || question.OptionD }
            ].filter(opt => opt.text);

            return options.map(option => `
                <div class="option-item ${answers[question.id] === option.id ? 'selected' : ''}" 
                     onclick="selectAnswer(${question.id}, '${option.id}')">
                    <div class="option-letter">${option.id}</div>
                    <div>${option.text}</div>
                </div>
            `).join('');
        }

        // Answer Selection
        function selectAnswer(questionId, optionId) {
            answers[questionId] = optionId;
            
            // Update UI
            const options = document.querySelectorAll('.option-item');
            options.forEach(option => {
                option.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            // Update navigation buttons (to show/hide submit button based on answered questions)
            updateNavigation();
            renderNavigation();
        }

        // Navigation
        function renderNavigation() {
            const container = document.getElementById('questionNavigation');
            const totalQuestions = examData.questions.length;

            const navHtml = Array.from({ length: totalQuestions }, (_, i) => {
                const isAnswered = answers[examData.questions[i].id] !== null;
                const isCurrent = i === currentQuestionIndex;
                
                let className = 'nav-btn';
                if (isCurrent) className += ' active';
                else if (isAnswered) className += ' answered';
                else className += ' unanswered';

                return `<button class="${className}" onclick="goToQuestion(${i})">${i + 1}</button>`;
            }).join('');

            container.innerHTML = navHtml;
        }

        function updateNavigation() {
            renderNavigation();
        }

        function goToQuestion(index) {
            if (index >= 0 && index < examData.questions.length) {
                renderQuestion(index);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < examData.questions.length - 1) {
                goToQuestion(currentQuestionIndex + 1);
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                goToQuestion(currentQuestionIndex - 1);
            }
        }

        function updateQuestionCounter() {
            const counter = document.getElementById('questionCounter');
            if (counter) {
                counter.textContent = `Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${examData.questions.length}`;
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const headerSubmitBtn = document.getElementById('headerSubmitBtn');
            
            // Check if all questions are answered
            const allQuestionsAnswered = examData.questions.every(q => answers[q.id] !== null);
            
            // Show/hide previous button
            if (prevBtn) {
                prevBtn.style.display = currentQuestionIndex > 0 ? 'flex' : 'none';
            }
            
            // Show/hide next button
            if (nextBtn) {
                nextBtn.style.display = currentQuestionIndex < examData.questions.length - 1 ? 'flex' : 'none';
            }
            
            // Show submit button only on last question and all questions are answered
            if (submitBtn) {
                const isLastQuestion = currentQuestionIndex === examData.questions.length - 1;
                submitBtn.style.display = (isLastQuestion && allQuestionsAnswered) ? 'flex' : 'none';
            }
            
            // Show/hide header submit button - only when all questions are answered
            if (headerSubmitBtn) {
                headerSubmitBtn.style.display = allQuestionsAnswered ? 'flex' : 'none';
            }
        }

        // Progress
        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / examData.questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // Submit Exam
        async function submitExam() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….')) {
                return;
            }

            try {
                clearInterval(timer);
                showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

                // Prepare answers as Dictionary<int, int>
                const answersDict = {};
                examData.questions.forEach((question, index) => {
                    const answer = answers[question.id];
                    if (answer) {
                        // Convert letter answer to number (A=0, B=1, C=2, D=3)
                        const answerNumber = answer.charCodeAt(0) - 65; // 'A' = 65
                        answersDict[index] = answerNumber;
                    }
                });

                console.log('ğŸ“¤ Submitting exam:', answersDict);

                const result = await api.submitStudentExam(examId, {
                    answers: answersDict
                });

                console.log('âœ… Exam submitted:', result);
                showAlert('ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');

                // Redirect to results
                setTimeout(() => {
                    window.location.href = `result-details.html?id=${examId}`;
                }, 2000);

            } catch (error) {
                console.error('âŒ Error submitting exam:', error);
                hideLoading();
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'danger');
            }
        }

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === 'n') {
                nextQuestion();
            } else if (e.key === 'ArrowLeft' || e.key === 'p') {
                previousQuestion();
            } else if (e.key >= '1' && e.key <= '9') {
                const questionIndex = parseInt(e.key) - 1;
                if (questionIndex < examData.questions.length) {
                    goToQuestion(questionIndex);
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadExam);
    </script>
</body>

</html>
