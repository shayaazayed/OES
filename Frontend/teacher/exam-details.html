<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - ExamPro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header
            style="background: white; padding: 1rem 1.5rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        <i class="fas fa-arrow-right"></i>
                        Ø±Ø¬ÙˆØ¹
                    </button>
                    <div>
                        <h1 id="pageTitle"
                            style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800); margin: 0;">
                            ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
                        <p id="pageSubtitle" style="color: var(--gray-600); margin: 0; font-size: 0.9rem;">Ø¬Ø§Ø±ÙŠ
                            Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button id="publishBtn" class="btn btn-success" onclick="togglePublish()" style="display: none;">
                        <i class="fas fa-upload"></i>
                        <span id="publishBtnText">Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                    </button>
                    <button class="btn btn-danger" onclick="deleteExam()">
                        <i class="fas fa-trash"></i>
                        Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
            </div>
        </header>

        <!-- ===== Exam Summary Card (Shows first!) ===== -->
        <div id="examSummaryCard" class="card" style="margin-bottom: 2rem; display: none;">
            <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                <!-- Exam Icon -->
                <div
                    style="width: 70px; height: 70px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-clipboard-list" style="font-size: 2rem; color: white;"></i>
                </div>
                <!-- Exam Title & Course -->
                <div style="flex: 1; min-width: 200px;">
                    <h2 id="examNameDisplay"
                        style="font-size: 1.6rem; font-weight: 800; color: var(--gray-800); margin: 0 0 0.25rem;">
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </h2>
                    <p id="examCourseDisplay" style="color: var(--gray-500); margin: 0; font-size: 0.95rem;">
                        <i class="fas fa-graduation-cap" style="margin-left: 0.3rem;"></i>
                        <span>â€”</span>
                    </p>
                </div>
                <!-- Stats Badges -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div
                        style="text-align: center; padding: 0.75rem 1.25rem; background: var(--gray-50); border-radius: 12px; border: 1px solid var(--gray-200);">
                        <div id="statDuration" style="font-size: 1.3rem; font-weight: 800; color: #3b82f6;">â€”</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.15rem;">Ø¯Ù‚ÙŠÙ‚Ø©</div>
                    </div>
                    <div
                        style="text-align: center; padding: 0.75rem 1.25rem; background: var(--gray-50); border-radius: 12px; border: 1px solid var(--gray-200);">
                        <div id="statTotalMarks" style="font-size: 1.3rem; font-weight: 800; color: #10b981;">â€”</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.15rem;">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©
                        </div>
                    </div>
                    <div
                        style="text-align: center; padding: 0.75rem 1.25rem; background: var(--gray-50); border-radius: 12px; border: 1px solid var(--gray-200);">
                        <div id="statPassingScore" style="font-size: 1.3rem; font-weight: 800; color: #f59e0b;">â€”</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.15rem;">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                    </div>
                    <div
                        style="text-align: center; padding: 0.75rem 1.25rem; background: var(--gray-50); border-radius: 12px; border: 1px solid var(--gray-200);">
                        <div id="statStatus" style="font-size: 1.3rem; font-weight: 800; color: #8b5cf6;">â€”</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.15rem;">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Main Content Grid ===== -->
        <div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem; align-items: start;">
            <!-- Exam Info Sidebar (Edit Form) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-edit"
                            style="margin-left: 0.5rem; color: var(--primary);"></i>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                </div>
                <form id="editExamForm">
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                        <input type="text" id="examTitle" class="form-control" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                        <input type="number" id="examDuration" class="form-control" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</label>
                        <input type="number" id="totalMarks" class="form-control" readonly
                            style="background: var(--gray-100);">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</label>
                        <input type="number" id="passingScore" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i>
                        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </form>
            </div>

            <!-- Questions Section -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title"><i class="fas fa-list-ol"
                            style="margin-left: 0.5rem; color: var(--primary);"></i>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                    <button class="btn btn-primary" onclick="showAddQuestionModal()">
                        <i class="fas fa-plus"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„
                    </button>
                </div>
                <div id="questionsList">
                    <!-- Questions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Question Modal (HIDDEN by default - uses separate style for display) -->
    <div id="addQuestionModal"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; display: none;">
        <div
            style="background: white; padding: 2rem; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 id="questionModalTitle" style="margin-top: 0; color: var(--gray-800);">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="questionForm">
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                    <textarea id="questionText" class="form-control" rows="3" required></textarea>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Ø§Ù„Ø¯Ø±Ø¬Ø© (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                    <input type="number" id="questionMarks" class="form-control" min="1">
                    <small style="color: var(--gray-500);">Ø¥Ø°Ø§ ØªØ±ÙƒØª Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                    <select id="questionType" class="form-control" onchange="toggleQuestionType()">
                        <option value="MultipleChoice">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                        <option value="TrueFalse">ØµØ­ Ø£Ùˆ Ø®Ø·Ø£</option>
                    </select>
                </div>

                <!-- Options Section -->
                <div id="optionsSection">
                    <label class="form-label">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)</label>
                    <div id="optionsContainer">
                        <!-- Options will be generated here -->
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideAddQuestionModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Global variables
        let currentExam = null;
        let isEditingQuestion = false;
        let currentQuestionId = null;
        let currentQuestions = []; // Store questions for counting

        // Helper to get Exam ID reliably from MULTIPLE sources
        function getExamId() {
            // Source 1: URL query params (?id=123)
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            console.log('ğŸ” Source 1 (URL params) id:', id);

            // Source 2: URL hash (#123)
            if (!id || id === 'null' || id === 'undefined') {
                const hash = window.location.hash.replace('#', '');
                if (hash && hash !== 'null' && hash !== 'undefined') {
                    id = hash;
                    console.log('ğŸ” Source 2 (URL hash) id:', id);
                }
            }

            // Source 3: sessionStorage (set by dashboard before navigating)
            if (!id || id === 'null' || id === 'undefined') {
                id = sessionStorage.getItem('currentExamId');
                console.log('ğŸ” Source 3 (sessionStorage) id:', id);
            }

            // Final validation
            if (!id || id === 'null' || id === 'undefined') {
                console.error('âŒ Exam ID not found in ANY source');
                return null;
            }

            console.log('âœ… Final Exam ID resolved:', id);
            return id;
        }

        const examId = getExamId();
        console.log('ğŸ“ Exam Details - Using ExamID:', examId, '| Full URL:', window.location.href);

        // Check auth and load data
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ DOM Loaded');

            // 1. Auth Check
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userType = user.UserType || user.userType;

            if (!token || userType !== 'Teacher') {
                console.log('âŒ Auth failed', { token: !!token, userType });
                window.location.href = '../login.html';
                return;
            }

            // 2. Exam ID Check
            if (!examId) {
                console.error('âŒ Missing Exam ID');
                showFullPageError('Ø±Ù‚Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙÙ‚ÙˆØ¯', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø£Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù†Ø§Ù‚Øµ.');
                return;
            }

            // 3. Load Data
            await loadExamDetails();
            await loadQuestions();
        });

        // Show Full Page Error (Removes all other content)
        function showFullPageError(title, message) {
            document.body.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #f3f4f6; font-family: 'Inter', sans-serif;">
                    <div style="background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); text-align: center; max-width: 500px; width: 90%;">
                        <div style="width: 80px; height: 80px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #ef4444;"></i>
                        </div>
                        <h1 style="font-size: 1.75rem; font-weight: 700; color: #111827; margin-bottom: 1rem;">${title}</h1>
                        <p style="color: #6b7280; margin-bottom: 2rem; line-height: 1.6;">${message}</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                             <button onclick="window.location.reload()" style="padding: 0.75rem 1.5rem; background: white; border: 1px solid #d1d5db; border-radius: 8px; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                            </button>
                            <button onclick="window.location.href='dashboard.html'" style="padding: 0.75rem 1.5rem; background: #2563eb; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load Exam Details
        async function loadExamDetails() {
            try {
                const exams = await api.getTeacherExams();
                console.log('ğŸ“‹ All exams:', exams);
                console.log('ğŸ” Looking for examId:', examId);

                currentExam = exams.find(e => (e.Id || e.id) == examId);
                console.log('âœ… Found exam:', currentExam);

                if (!currentExam) {
                    throw new Error('Exam not found in list');
                }

                // Support both camelCase (from ASP.NET default) and PascalCase
                const title = currentExam.title || currentExam.Title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
                const course = currentExam.courseName || currentExam.CourseName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const duration = currentExam.durationMinutes || currentExam.DurationMinutes || 0;
                const totalMarks = currentExam.totalMarks || currentExam.TotalMarks || 0;
                const passingScore = currentExam.passingScore || currentExam.PassingScore || 0;
                const isPublished = currentExam.isPublished || currentExam.IsPublished || false;

                console.log('ğŸ“ Exam data:', { title, course, duration, totalMarks, passingScore, isPublished });

                // Update Page Header
                document.getElementById('pageTitle').textContent = title;
                document.getElementById('pageSubtitle').textContent = course;

                // Update Summary Card
                document.getElementById('examNameDisplay').textContent = title;
                document.getElementById('examCourseDisplay').innerHTML = `<i class="fas fa-graduation-cap" style="margin-left: 0.3rem;"></i> ${course}`;
                document.getElementById('statDuration').textContent = duration;
                document.getElementById('statTotalMarks').textContent = totalMarks;
                document.getElementById('statPassingScore').textContent = passingScore;
                document.getElementById('statStatus').textContent = isPublished ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©';
                document.getElementById('statStatus').style.color = isPublished ? '#10b981' : '#f59e0b';

                // Show summary card
                document.getElementById('examSummaryCard').style.display = 'block';

                // Fill Edit Form
                document.getElementById('examTitle').value = title;
                document.getElementById('examDuration').value = duration;
                document.getElementById('totalMarks').value = totalMarks;
                document.getElementById('passingScore').value = passingScore;

                // Update browser tab title
                document.title = `${title} - ExamPro`;

                updatePublishButton();

            } catch (error) {
                console.error('Error loading exam:', error);
                showFullPageError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ø±Ø¨Ù…Ø§ ØªÙ… Ø­Ø°ÙÙ‡ Ø£Ùˆ Ø£Ù†Ùƒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡.');
            }
        }

        // Load Questions
        async function loadQuestions() {
            try {
                const response = await fetch(`${api.baseURL}/teacher/exams/${examId}/questions`, {
                    headers: { 'Authorization': `Bearer ${api.token}` }
                });

                if (response.ok) {
                    const questions = await response.json();
                    currentQuestions = questions; // Store questions for counting
                    displayQuestions(questions);
                } else {
                    document.getElementById('questionsList').innerHTML = '<p class="text-center text-danger">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>';
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questionsList').innerHTML = '<p class="text-center text-danger">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</p>';
            }
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsList');
            if (!questions || questions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-600);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯.</div>';
                return;
            }

            container.innerHTML = questions.map((q, index) => {
                const id = q.Id || q.id;
                const text = q.QuestionText || q.questionText || '';
                const marks = q.Marks || q.marks || 0;
                const order = q.QuestionOrder || q.questionOrder || index + 1;
                const ca = q.CorrectAnswer || q.correctAnswer;
                const optA = q.OptionA || q.optionA || '-';
                const optB = q.OptionB || q.optionB || '-';
                const optC = q.OptionC || q.optionC || '-';
                const optD = q.OptionD || q.optionD || '-';

                return `
                <div class="question-card" style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <span style="font-weight: bold; color: var(--primary);">Ø³Ø¤Ø§Ù„ ${order}:</span>
                            <span style="margin-right: 0.5rem;">${text}</span>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">
                                Ø§Ù„Ø¯Ø±Ø¬Ø©: ${marks}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-danger btn-sm" onclick="deleteQuestion(${id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <ul style="margin-top: 1rem; padding-right: 1.5rem; list-style-type: none;">
                        <li style="${ca === 'A' ? 'color: var(--success); font-weight: bold;' : ''}">A: ${optA} ${ca === 'A' ? 'âœ”' : ''}</li>
                        <li style="${ca === 'B' ? 'color: var(--success); font-weight: bold;' : ''}">B: ${optB} ${ca === 'B' ? 'âœ”' : ''}</li>
                        <li style="${ca === 'C' ? 'color: var(--success); font-weight: bold;' : ''}">C: ${optC} ${ca === 'C' ? 'âœ”' : ''}</li>
                        <li style="${ca === 'D' ? 'color: var(--success); font-weight: bold;' : ''}">D: ${optD} ${ca === 'D' ? 'âœ”' : ''}</li>
                    </ul>
                </div>
            `;
            }).join('');
        }

        // Modal Functions
        function showAddQuestionModal() {
            // Re-verify examId before working
            if (!getExamId()) {
                showAlert('Ø±Ù‚Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙÙ‚ÙˆØ¯! Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.', 'danger');
                return;
            }

            isEditingQuestion = false;
            currentQuestionId = null;
            document.getElementById('questionModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('questionForm').reset();
            document.getElementById('questionType').value = 'MultipleChoice';
            toggleQuestionType();
            document.getElementById('addQuestionModal').style.display = 'flex';
        }

        function hideAddQuestionModal() {
            document.getElementById('addQuestionModal').style.display = 'none';
        }

        function toggleQuestionType() {
            try {
                const type = document.getElementById('questionType').value;
                const container = document.getElementById('optionsContainer');
                if (!container) return; // guard

                container.innerHTML = '';

                if (type === 'TrueFalse') {
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <input type="radio" name="correctOption" value="A" required>
                            <span>ØµØ­</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <input type="radio" name="correctOption" value="B" required>
                            <span>Ø®Ø·Ø£</span>
                        </div>
                    `;
                } else {
                    ['A', 'B', 'C', 'D'].forEach(opt => {
                        container.innerHTML += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="radio" name="correctOption" value="${opt}" required>
                                <span style="font-weight: bold; width: 20px;">${opt}:</span>
                                <input type="text" id="option${opt}" class="form-control" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± ${opt}" required>
                            </div>
                        `;
                    });
                }

                // NO DOM MANIPULATION ON 'optionsSection button' HERE
                // because it causes errors if button doesn't exist or layout changes
            } catch (e) {
                console.error('Error in toggleQuestionType:', e);
            }
        }

        // Handle Question Form Submit
        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Safety Check
            const activeId = getExamId();
            if (!activeId) {
                showAlert('Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙÙ‚ÙˆØ¯. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.', 'danger');
                return;
            }

            const questionText = document.getElementById('questionText').value;
            const marksInput = document.getElementById('questionMarks').value;
            const type = document.getElementById('questionType').value;
            const correctRadio = document.querySelector('input[name="correctOption"]:checked');

            if (!correctRadio) {
                showAlert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©', 'warning');
                return;
            }

            // Calculate marks automatically if not provided
            let marks;
            if (marksInput === '' || marksInput === null || isNaN(parseInt(marksInput))) {
                // Get current exam total marks and calculate auto marks
                const totalMarks = currentExam?.totalMarks || currentExam?.TotalMarks || 0;
                // Get current number of questions from stored array (we'll add 1 for the new question)
                const questionsCount = currentQuestions?.length || 0;
                marks = questionsCount > 0 ? Math.ceil(totalMarks / (questionsCount + 1)) : 1;
                console.log('ğŸ”„ Auto-calculated marks:', marks, '| Total:', totalMarks, '| Questions:', questionsCount);
            } else {
                marks = parseInt(marksInput);
            }

            const correctAnswer = correctRadio.value;
            let optionA, optionB, optionC, optionD;

            if (type === 'TrueFalse') {
                optionA = "ØµØ­";
                optionB = "Ø®Ø·Ø£";
                optionC = "-";
                optionD = "-";
            } else {
                optionA = document.getElementById('optionA').value;
                optionB = document.getElementById('optionB').value;
                optionC = document.getElementById('optionC').value;
                optionD = document.getElementById('optionD').value;
            }

            const payload = {
                QuestionText: questionText,
                OptionA: optionA,
                OptionB: optionB,
                OptionC: optionC,
                OptionD: optionD,
                CorrectAnswer: correctAnswer,
                Marks: marks
            };

            try {
                const url = `${api.baseURL}/teacher/exams/${activeId}/questions`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${api.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    // Automatically update exam total marks if marks were auto-calculated
                    if (marksInput === '' || marksInput === null || isNaN(parseInt(marksInput))) {
                        await updateExamTotalMarks();
                    }
                    
                    hideAddQuestionModal();
                    loadQuestions();
                } else {
                    const error = await response.text();
                    try {
                        const jsonError = JSON.parse(error);
                        let msg = jsonError.message || jsonError.title || 'Validation Error';
                        if (jsonError.errors) {
                            msg += ': ' + JSON.stringify(jsonError.errors);
                        }
                        showAlert('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + msg, 'danger');
                    } catch (e) {
                        showAlert('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + error, 'danger');
                    }
                }
            } catch (error) {
                console.error(error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'danger');
            }
        });

        // Handle Exam Info Edit
        document.getElementById('editExamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const activeId = getExamId();
            if (!activeId) return;

            const title = document.getElementById('examTitle').value;
            const duration = parseInt(document.getElementById('examDuration').value);
            const passingScore = parseInt(document.getElementById('passingScore').value);

            const payload = {
                Title: title,
                Description: currentExam?.description || currentExam?.Description || '',
                DurationMinutes: duration,
                TotalMarks: currentExam?.totalMarks || currentExam?.TotalMarks || 0,
                PassingScore: passingScore,
                StartDate: currentExam?.startDate || currentExam?.StartDate,
                EndDate: currentExam?.endDate || currentExam?.EndDate
            };

            try {
                await api.request(`/teacher/exams/${activeId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });

                showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                if (currentExam) {
                    currentExam.title = title;
                    currentExam.durationMinutes = duration;
                    currentExam.passingScore = passingScore;
                }
            } catch (error) {
                console.error('Error updating exam info:', error);
                showAlert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', 'danger');
            }
        });

        // Update Exam Total Marks
        async function updateExamTotalMarks() {
            const activeId = getExamId();
            if (!activeId) return;

            try {
                const totalMarks = currentQuestions.reduce((sum, q) => {
                    const marks = parseInt(q.Marks || q.marks || 1);
                    return sum + marks;
                }, 0);

                const response = await api.request(`/teacher/exams/${activeId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        Title: currentExam?.title || currentExam?.Title || '',
                        Description: currentExam?.description || currentExam?.Description || '',
                        DurationMinutes: currentExam?.durationMinutes || currentExam?.DurationMinutes || 60,
                        TotalMarks: totalMarks,
                        PassingScore: currentExam?.passingScore || currentExam?.PassingScore || 50,
                        StartDate: currentExam?.startDate || currentExam?.StartDate,
                        EndDate: currentExam?.endDate || currentExam?.EndDate
                    })
                });

                if (response.ok) {
                    console.log('âœ… Total marks updated successfully:', totalMarks);
                    if (currentExam) {
                        currentExam.totalMarks = totalMarks;
                        currentExam.TotalMarks = totalMarks;
                    }
                } else {
                    console.log('âš ï¸ Total marks update skipped - backend may not support this field');
                }
            } catch (error) {
                console.log('âš ï¸ Total marks update skipped:', error.message);
            }
        }

        // Toggle Publish
        async function togglePublish() {
            const activeId = getExamId();
            if (!activeId) return;

            if (currentExam && (currentExam.isPublished || currentExam.IsPublished)) {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø± Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
                return;
            }

            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙˆØ±Ø§Ù‹.')) return;

            try {
                await api.publishExam(activeId);
                showAlert('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                if (currentExam) { currentExam.isPublished = true; currentExam.IsPublished = true; }
                updatePublishButton();
            } catch (error) {
                console.error('Error publishing exam:', error);
                showAlert('ÙØ´Ù„ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'danger');
            }
        }

        function updatePublishButton() {
            if (!currentExam) return;
            const btn = document.getElementById('publishBtn');
            const btnText = document.getElementById('publishBtnText');
            btn.style.display = 'inline-flex';
            if (currentExam.isPublished || currentExam.IsPublished) {
                btn.className = 'btn btn-warning';
                btnText.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±';
            } else {
                btn.className = 'btn btn-success';
                btnText.textContent = 'Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
            }
        }

        // Delete Exam
        async function deleteExam() {
            const activeId = getExamId();
            if (!activeId) return;

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
                try {
                    await api.request(`/teacher/exams/${activeId}`, { method: 'DELETE' });
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    setTimeout(() => window.location.href = 'dashboard.html', 1500);
                } catch (error) {
                    console.error('Error deleting exam:', error);
                    showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'danger');
                }
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 600; z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                background: ${type === 'success' ? '#10b981' : type === 'danger' ? '#ef4444' : '#3b82f6'};
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }
    </script>
</body>

</html>