<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª - ExamPro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header
            style="background: white; padding: 1rem 0; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        <i class="fas fa-arrow-right"></i>
                        Ø±Ø¬ÙˆØ¹
                    </button>
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800); margin: 0;">Ø¥Ø¯Ø§Ø±Ø©
                            Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 0.9rem;">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-primary" onclick="createNewCourse()">
                        <i class="fas fa-plus"></i>
                        Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                    <button class="btn btn-secondary" onclick="performLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </header>

        <!-- Courses List -->
        <div id="coursesContainer" style="margin-bottom: 2rem;">
            <!-- Courses will be loaded here -->
        </div>

        <!-- Create Course Modal -->
        <div id="createCourseModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
            <div
                style="background: white; padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h2 id="modalTitle" style="margin-top: 0; color: var(--gray-800);">Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <form id="createCourseForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© *</label>
                        <input type="text" id="courseName" required
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ÙˆØµÙ Ø§Ù„Ø¯ÙˆØ±Ø©</label>
                        <textarea id="courseDescription" rows="3"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;"></textarea>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="hideCreateCourseModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary"><span id="submitBtnText">Ø¥Ù†Ø´Ø§Ø¡
                                Ø§Ù„Ø¯ÙˆØ±Ø©</span></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Check authentication
        if (!checkAuth()) {
            window.location.href = '../login.html';
        }

        // Check if user is teacher
        if (!api.isTeacher()) {
            showAlert('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©', 'danger');
            setTimeout(() => {
                window.location.href = '../login.html';
            }, 2000);
        }

        // Global variables
        let isEditing = false;
        let currentCourseId = null;
        let allCourses = [];

        // Load teacher's courses
        async function loadCourses() {
            try {
                console.log('ğŸ“š Loading teacher courses...');
                allCourses = await api.getTeacherCourses();
                displayCourses(allCourses);
            } catch (error) {
                console.error('âŒ Failed to load courses:', error);
                showAlert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª: ' + error.message, 'danger');
            }
        }

        // Display courses
        function displayCourses(courses) {
            const container = document.getElementById('coursesContainer');

            if (!courses || courses.length === 0) {
                container.innerHTML = '<div class="card"><div style="text-align: center; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª</div></div>';
                return;
            }

            const coursesHtml = courses.map(course => {
                const id = course.Id || course.id;
                const name = course.CourseName || course.courseName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                const description = course.Description || course.description || '';
                const studentCount = course.StudentCount || course.studentCount || 0;
                const examCount = course.ExamCount || course.examCount || 0;
                const createdDate = course.CreatedDate || course.createdDate;

                return `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--gray-800); margin-bottom: 0.5rem;">${name}</h3>
                                <p style="color: var(--gray-600); font-size: 0.9rem; margin-bottom: 1rem;">${description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-warning btn-sm" onclick="openEditModal(${id})">
                                    <i class="fas fa-edit"></i>
                                    ØªØ¹Ø¯ÙŠÙ„
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCourse(${id})">
                                    <i class="fas fa-trash"></i>
                                    Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-100);">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--gray-500); font-size: 0.8rem;">
                                    <i class="fas fa-users"></i> ${studentCount} Ø·Ø§Ù„Ø¨
                                </span>
                                <span style="color: var(--gray-500); font-size: 0.8rem;">
                                    <i class="fas fa-clipboard-list"></i> ${examCount} Ø§Ø®ØªØ¨Ø§Ø±
                                </span>
                            </div>
                            <div style="color: var(--gray-500); font-size: 0.8rem;">
                                ${formatDate(createdDate)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            container.innerHTML = coursesHtml;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®';
            }
        }

        // Show/Hide Modal
        function showCreateCourseModal() {
            isEditing = false;
            currentCourseId = null;
            document.getElementById('modalTitle').textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            document.getElementById('submitBtnText').textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø©';
            document.getElementById('createCourseForm').reset();
            document.getElementById('createCourseModal').style.display = 'flex';
        }

        function openEditModal(id) {
            const course = allCourses.find(c => (c.Id || c.id) == id);
            if (!course) {
                console.error('Course not found:', id);
                return;
            }

            const name = course.CourseName || course.courseName || '';
            const description = course.Description || course.description || '';

            isEditing = true;
            currentCourseId = id;
            document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©';
            document.getElementById('submitBtnText').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            document.getElementById('courseName').value = name;
            document.getElementById('courseDescription').value = description;
            document.getElementById('createCourseModal').style.display = 'flex';
        }

        function hideCreateCourseModal() {
            document.getElementById('createCourseModal').style.display = 'none';
        }

        function createNewCourse() {
            showCreateCourseModal();
        }

        // Handle Form Submit
        document.getElementById('createCourseForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('courseName').value;
            const description = document.getElementById('courseDescription').value;

            try {
                if (isEditing) {
                    // Find existing course to keep its CourseCode
                    const existingCourse = allCourses.find(c => (c.Id || c.id) == currentCourseId);
                    const courseCode = existingCourse ? (existingCourse.CourseCode || existingCourse.courseCode) : ('C-' + Date.now());

                    await api.updateCourse(currentCourseId, {
                        Id: currentCourseId,
                        CourseName: name,
                        Description: description,
                        CourseCode: courseCode // Include existing CourseCode
                    });
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    await api.createCourse({
                        CourseName: name,
                        Description: description,
                        CourseCode: 'C-' + Math.floor(Math.random() * 10000) + '-' + Date.now().toString().slice(-6)
                    });
                    showAlert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }

                hideCreateCourseModal();
                loadCourses();
            } catch (error) {
                console.error('Operation failed:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'danger');
            }
        });

        // Delete course
        async function deleteCourse(courseId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§!')) {
                try {
                    await api.deleteCourse(courseId);
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    loadCourses();
                } catch (error) {
                    console.error('âŒ Failed to delete course:', error);
                    showAlert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø©: ' + error.message, 'danger');
                }
            }
        }

        // Logout function
        function performLogout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                api.logout();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadCourses();
        });
    </script>
</body>

</html>